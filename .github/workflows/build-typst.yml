name: Build Typst to HTML

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  TYPST_REF: 7278d887cf05fadc9a96478830e5876739b78f53  # Change this to your desired Typst version, commit hash, or branch

jobs:
  build:
    runs-on: ubuntu-latest
  
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    # - name: Setup Rust toolchain
    #   uses: actions-rs/toolchain@v1
    #   with:
    #     toolchain: stable
    #     override: true

    # - name: Clone and build Typst from source
    #   run: |
    #     # Clone Typst repository
    #     git clone https://github.com/typst/typst.git typst-source
    #     cd typst-source
        
    #     # Checkout specified ref (version tag, commit hash, or branch) from environment variable
    #     echo "Building Typst from ref: $TYPST_REF"
    #     git checkout $TYPST_REF
        
    #     # Build Typst CLI
    #     echo "Building Typst CLI..."
    #     cargo build --release --package typst-cli
        
    #     # Copy the binary to a location in PATH
    #     sudo cp target/release/typst /usr/local/bin/typst
        
    #     # Verify installation
    #     echo "Typst installation complete:"
    #     typst --version
        

    - name: ðŸ“ Prepare cargo cache
      uses: awalsh128/cache-apt-pkgs-action@v1
      with:
        packages: cargo
        version: 1.0

    - name: ðŸ“¥ Install typst-test from GitHub
      uses: baptiste0928/cargo-install@91c5da15570085bcde6f4d7aed98cb82d6769fd3
      with:
        crate: typst-cli
        git: https://github.com/typst/typst.git
        commit: 7278d887cf05fadc9a96478830e5876739b78f53

    - name: Build Typst project
      run: |
        # Run Python build script for production
        python3 build.py production
        
    - name: Prepare deployment directory
      run: |
        # Clean up build artifacts to avoid embedded git repository issues
        rm -rf typst-source
          
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: typst-html-output
        path: dist/
        
    - name: Setup Pages
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: actions/configure-pages@v4
      
    - name: Upload to GitHub Pages
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: actions/upload-pages-artifact@v3
      with:
        path: dist
        
    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: Display deployment URL
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        echo "ðŸš€ Deployment successful!"
        echo "ðŸ“„ Your Typst document is now available at:"
        echo "ðŸ”— ${{ steps.deployment.outputs.page_url }}"
        echo ""
        echo "## ðŸŽ‰ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Status:** Successfully deployed" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— **URL:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“ **Document:** test.html" >> $GITHUB_STEP_SUMMARY
        